"use strict";(self.webpackChunkcircle=self.webpackChunkcircle||[]).push([[127],{4966:function(e,n,r){r.d(n,{Z:function(){return o}});var s=r(2791),a="index_headerWrap__7KmC+",t=r(184),i=function(e){var n=e.children,r=e.style,s=void 0===r?{}:r;return(0,t.jsx)("div",{className:a,style:s,children:n})},o=(0,s.memo)(i)},384:function(e,n,r){r.r(n),r.d(n,{default:function(){return Oe}});var s=r(1413),a=r(4165),t=r(5861),i=r(2791),o="index_channelWrap__2Cl0G",l="index_contentWrap__-dE+q",c="index_messageWrap__X7yBX",d="index_iptWrap__1Oivy",u="index_main__vuf9Z",h="index_side__2dEpe",v="index_drawerWrap__vPCX7",p="index_drawerBody__SoY4n",f="index_icon__VK19H",m="index_drawerHeader__6Q1tE",x="index_iconCon__90kXp",_="index_invite__b2bry",I="index_close__GD7QC",g=r(9439),j={name:"index_name__Dg-KW",base:"index_base__261L6",private:"index_private__lIo5s",optWrap:"index_optWrap__euZay",icon:"index_icon__n77Kx",popover:"index_popover__Q5UbL",iconCon:"index_iconCon__1dXWd"},C=r(4966),Z=r(1091),b=r(3020),y=r(6573),M=r(6014),N=r(7196),T=r(3433),k="index_layout__xZ0mN",S="index_headerThread__yiUwL",w="index_headerTitle__vlJ89",L="index_HeaderIcon__W7gCL",U="index_list__HzFPb",z="index_defaultTips__BSNZV",W="index_tips1__nyPx8",O="index_item__kIqm6",V="index_itemCon__KAERQ",R="index_itemName__DvFdE",P="index_itemBottom__KLB-C",E="index_noMessage__RO9tL",H="index_leftCon__E7YW7",X="index_avatar__pLH7v",F="index_ownerName__XOymd",A="index_message__Q7e4O",D="index_itemOwner__PVvVq",B="index_itemMsg__2HJcD",K="index_itemTime__4XDAS",J=r(8687),Q=r(8406),Y=r(6871),$=r(7411),G=r(2718),q=r(4771),ee=r(184),ne="threadListScrollId",re=function(e){if(0===e.length)return(0,ee.jsx)("div",{className:z,children:(0,ee.jsxs)("div",{className:W,children:[(0,ee.jsx)("span",{className:"tlp-tips1-img"}),"\u5f53\u524d\u6ca1\u6709\u5b50\u533a"]})})},se=(0,i.memo)((0,J.$j)((function(e){var n=e.app;return{serverRole:n.serverRole,appUserInfo:n.appUserInfo}}),(function(e){return{handleThreadPanel:function(n){return e({type:"thread/setThreadPanelStatus",payload:n})},setThreadInfo:function(n){return e({type:"thread/setThreadInfo"})}}}))((function(e){var n=e.serverRole,r=e.appUserInfo,s=e.onHandleOperation,a=e.onClose,t=e.visibleThread,o=(0,Y.UO)(),l=o.serverId,c=o.channelId,d=n[l],u=(0,i.useState)([]),h=(0,g.Z)(u,2),v=h[0],p=h[1];(0,i.useEffect)((function(){t?y(d):b("")}),[d,t]);var f=(0,i.useState)(!0),m=(0,g.Z)(f,2),x=m[0],_=m[1],I=(0,i.useState)(null),j=(0,g.Z)(I,2),C=j[0],b=j[1],y=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r="user"!==e?"getChatThreads":"getJoinedChatThreads",s={parentId:c,pageSize:20,cursor:n};$.Z.conn[r](s).then((function(e){var n=e.entities;if(0!==n.length){20===n.length?_(!0):_(!1),b(e.properties.cursor);var r=n.map((function(e){return e.id}));$.Z.conn.getChatThreadLastMessage({chatThreadIds:r}).then((function(e){var r=e.entities;n.forEach((function(e){var n=r.find((function(n){return e.id===n.chatThreadId}));e.lastMessage=n&&n.lastMessage?n.lastMessage:{}})),p(""===C?n:[].concat((0,T.Z)(v),(0,T.Z)(n)))})).catch((function(){p(""===C?n:[].concat((0,T.Z)(v),(0,T.Z)(n)))}))}else s.isScroll||p(n)}))},M=function(e){switch(e.type){case"txt":return e.msg;case"file":return"\u6587\u4ef6";case"img":return"\u56fe\u7247";default:return""}};return(0,ee.jsxs)("div",{className:k,children:[(0,ee.jsxs)("div",{className:S,children:[(0,ee.jsx)("span",{className:w,children:"\u5b50\u533a\u5217\u8868"}),(0,ee.jsx)("div",{className:L,onClick:function(){return a()},children:(0,ee.jsx)(Z.Z,{name:"xmark",color:"#c7c7c7",size:"18px"})})]}),(0,ee.jsxs)("ul",{id:ne,className:U,children:[re(v),(0,ee.jsx)(q.Z,{dataLength:v.length||0,next:function(){y(d,C)},hasMore:x,loader:(0,ee.jsx)(ee.Fragment,{}),endMessage:(0,ee.jsx)(ee.Fragment,{}),scrollableTarget:ne,children:v.length>0&&v.map((function(e,n){var t,i,o,l,c;return(0,ee.jsx)("li",{className:O,onClick:function(n){return function(e){s("openThreadPanel",!0,e,"threadList"),a()}(e)},children:(0,ee.jsxs)("div",{className:V,children:[(0,ee.jsx)("div",{className:R,children:e.name}),e.lastMessage&&"{}"!==JSON.stringify(e.lastMessage)?(0,ee.jsxs)("div",{className:P,children:[(0,ee.jsxs)("div",{className:H,children:[(0,ee.jsx)("div",{className:X,children:(0,ee.jsx)(G.Z,{size:16,src:null===(t=r[null===(i=e.lastMessage)||void 0===i?void 0:i.from])||void 0===t?void 0:t.avatarurl})}),(0,ee.jsx)("div",{className:F,children:(0,ee.jsx)("span",{className:D,children:(null===(o=r[null===(l=e.lastMessage)||void 0===l?void 0:l.from])||void 0===o?void 0:o.nickname)||e.lastMessage.from})}),e.lastMessage&&(0,ee.jsx)("div",{className:A,children:(0,ee.jsx)("span",{className:B,children:(0,Q.BV)(M(e.lastMessage))})})]}),(0,ee.jsx)("span",{className:K,children:(0,Q.og)(null===(c=e.lastMessage)||void 0===c?void 0:c.time)})]}):(0,ee.jsx)("div",{className:P,children:(0,ee.jsx)("span",{className:E,children:"\u6700\u65b0\u6d88\u606f\u88ab\u64a4\u56de"})})]})},n)}))})]})]})}))),ae=function(e){var n=e.onHandleOperation,r=e.channelId,s=e.serverId,a=e.setChannelInfo,t=e.channelInfo,o=e.serverRole,l=e.joinedServerInfo,c=e.channelMemberVisible,d=(0,i.useState)(!1),u=(0,g.Z)(d,2),h=u[0],v=u[1],p=o[s];(0,i.useEffect)((function(){!function(e){var n=e.serverId,r=e.channelId;$.Z.conn.getChannelDetail({serverId:n,channelId:r}).then((function(e){a(e.data)}))}({serverId:s,channelId:r})}),[r,s]);var f=(0,Y.s0)();return(0,ee.jsxs)(C.Z,{children:[(0,ee.jsx)("span",{className:"".concat(j.name," ").concat(null!==t&&void 0!==t&&t.isPublic?"".concat(j.channelNameWrap," ").concat(j.base," "):"".concat(j.channelNameWrap," ").concat(j.private)),children:null===t||void 0===t?void 0:t.name}),(0,ee.jsxs)("div",{className:j.optWrap,children:[(0,ee.jsx)(b.Z,{placement:"bottomRight",content:(0,ee.jsx)(se,{onClose:function(){v(!1)},onHandleOperation:n,visibleThread:h}),trigger:"click",visible:h,onVisibleChange:function(e){v(e)},overlayClassName:j.popover,children:(0,ee.jsx)(y.Z,{title:"\u5b50\u533a\u5217\u8868",overlayClassName:"toolTip",children:(0,ee.jsx)("span",{children:(0,ee.jsx)(Z.Z,{iconClass:j.icon,size:"24px",name:"message_on_message"})})})}),(0,ee.jsx)(y.Z,{title:c?"\u9690\u85cf\u6210\u5458\u540d\u5355":"\u663e\u793a\u6210\u5458\u540d\u5355",overlayClassName:"toolTip",children:(0,ee.jsx)("div",{onClick:function(){n("showMember")},children:(0,ee.jsx)(Z.Z,{iconClass:j.icon,size:"24px",name:"person_2"})})}),p&&p!==N.N1.user&&(0,ee.jsx)(y.Z,{title:"\u9891\u9053\u8bbe\u7f6e",overlayClassName:"toolTip",children:(0,ee.jsx)("div",{onClick:function(){n("setting")},children:(0,ee.jsx)(Z.Z,{iconClass:j.icon,size:"24px",name:"gear"})})}),0===t.defaultChannel&&p&&p===N.N1.owner&&(0,ee.jsx)(M.Z,{onClick:function(e){"deleteChannel"===e.key&&$.Z.conn.destroyChannel({serverId:s,channelId:r}).then((function(){(0,Q.Qv)(s,r,!0);var e=l.list||[],n=e.findIndex((function(e){return e.id===s}));if(n>-1){var a=e[n].defaultChannelId;f("/main/channel/".concat(s,"/").concat(a))}}))},style:{padding:0},theme:"dark",selectable:!1,triggerSubMenuAction:"click",mode:"horizontal",items:te()})]})]})},te=function(){return[{label:(0,ee.jsx)("div",{className:j.iconCon,children:(0,ee.jsx)(Z.Z,{iconClass:j.icon,name:"ellipsis",size:"24px"})}),key:"SubMenu",children:[{label:(0,ee.jsxs)("div",{className:j.menuWrap,children:[(0,ee.jsx)(Z.Z,{name:"trash",size:"22px"}),(0,ee.jsx)("span",{children:"\u5220\u9664\u9891\u9053"})]}),key:"deleteChannel"}]}]},ie=(0,J.$j)((function(e){var n=e.app,r=e.server,s=e.channel;return{channelInfo:n.currentChannelInfo,serverRole:n.serverRole,joinedServerInfo:r.joinedServerInfo,channelMemberVisible:s.channelMemberVisible}}),(function(e){return{setChannelInfo:function(n){return e({type:"app/setCurrentChannelInfo",payload:n})}}}))((0,i.memo)(ae)),oe={name:"index_name__hXwKm",person:"index_person__kNyXs",base:"index_base__n-ZGI",scrollWrap:"index_scrollWrap__2mPer",iptWrap:"index_iptWrap__9eMt2"},le="index_modalWrap__eUYS6",ce=r(5873),de=r(8967),ue=function(e){var n=e.visible,r=e.onCancel,s=e.children,a=e.title;return(0,ee.jsx)("div",{className:le,children:(0,ee.jsx)(ce.Z,{width:"100%",style:{top:0},getContainer:!1,title:a,visible:n,mask:!1,footer:!1,destroyOnClose:!0,onCancel:function(){r()},closeIcon:(0,ee.jsx)(de.Z,{}),children:s})})},he=(0,i.memo)(ue),ve=r(149),pe=r(3695),fe="index_role__Qz-D+",me="index_creator__YZX+t",xe="index_admin__6TdNg",_e="index_optWrap__nX24z",Ie="index_iconWrap__+3sYB",ge=(0,i.memo)((0,J.$j)(null,(function(e){return{setSelected:function(n){return e({type:"app/setSelectedTab",payload:n})}}}))((function(e){var n=e.role,r=e.uid,s=e.serverId,a=e.isShowChat,t=void 0===a||a,i=e.menuItems,o=void 0===i?[]:i,l=e.showOpIcon,c=e.setSelected,d=e.isServer,u=e.onMenuClick,h=void 0===u?function(){}:u,v=(0,Y.s0)(),p=n===N.N1.owner;return(0,ee.jsxs)("div",{className:_e,children:[n!==N.N1.user&&(0,ee.jsx)("div",{className:"".concat(fe," ").concat(p?me:xe," "),style:{marginRight:d?"12px":"8px"},children:n===N.N1.owner?"\u521b\u5efa\u8005":"\u7ba1\u7406\u5458"}),t&&(0,ee.jsx)("div",{className:"".concat(d?"opBg":Ie),style:{marginRight:d?"12px":"8px"},onClick:function(){c("contacts"),v("/main/contacts/chat/".concat(r))},children:(0,ee.jsx)(Z.Z,{iconClass:"opIcon",name:"message_retangle"})}),l&&(0,ee.jsx)("div",{className:"".concat(d?"opBg":Ie),children:(0,ee.jsx)(M.Z,{onClick:function(e){h(e,{uid:r,serverId:s})},style:{padding:0},theme:"dark",selectable:!1,triggerSubMenuAction:"click",mode:"horizontal",items:o})})]})}))),je="memberScrollWrap",Ce=function(){return(0,ee.jsx)(C.Z,{style:{position:"unset",width:"100%"},children:(0,ee.jsxs)("span",{className:"".concat(oe.name," ").concat(oe.public),children:[(0,ee.jsx)("span",{className:oe.person,children:(0,ee.jsx)(Z.Z,{name:"person_2",color:"#fff",size:"26px"})}),"\u793e\u533a\u6210\u5458"]})})},Ze=function(e,n,r){var s=[];if(n===N.N1.owner||e===N.N1.user)return s;if(e===N.N1.owner){var a={};n===N.N1.user?a={label:(0,ee.jsxs)("div",{children:[(0,ee.jsx)(Z.Z,{name:"person_nut",size:"24px"}),(0,ee.jsx)("span",{children:"\u8bbe\u4e3a\u7ba1\u7406\u5458"})]}),key:"setAdmin"}:n===N.N1.moderator&&(a={label:(0,ee.jsxs)("div",{children:[(0,ee.jsx)(Z.Z,{name:"person_normal",size:"22px"}),(0,ee.jsx)("span",{children:"\u53d6\u6d88\u7ba1\u7406\u5458"})]}),key:"removeAdmin"}),s.push(a)}return(null===r||void 0===r?void 0:r.uid)!==$.Z.conn.user&&s.push({label:(0,ee.jsxs)("div",{children:[(0,ee.jsx)(Z.Z,{name:"minus_in_circle",size:"16px"}),(0,ee.jsx)("span",{children:"\u8e22\u51fa\u793e\u533a"})]}),key:"kick"}),s},be=function(e,n){return[{label:(0,ee.jsx)(Z.Z,{iconClass:"opIcon",name:"ellipsis"}),key:"SubMenu",children:Ze(e,n)}]},ye=(0,i.memo)((0,J.$j)((function(e){var n=e.channel,r=e.app,s=e.server;return{visible:n.memberVisible,appUserInfo:r.appUserInfo,serverUserMap:s.serverUserMap,serverRole:r.serverRole}}),(function(e){return{setVisible:function(n){return e({type:"channel/setVisible",payload:n})},setServerUserMap:function(n){return e({type:"server/setServerUserMap",payload:n})}}}))((function(e){var n,r,a=e.visible,t=e.setVisible,o=e.appUserInfo,l=e.setServerUserMap,c=e.serverUserMap,d=e.serverRole,u=(0,Y.UO)(),h=u.serverId,v=u.channelId,p=d&&d[h],f=(0,i.useMemo)((function(){return c.get(h)||{}}),[h,c]),m=function(e){var n,r=null===f||void 0===f||null===(n=f.list)||void 0===n?void 0:n.filter((function(n){return n.uid!==e}));l({serverId:h,userListInfo:(0,s.Z)((0,s.Z)({},c.get(h)),{},{list:r})})},x=function(e,n,r){var a=(0,T.Z)(null===f||void 0===f?void 0:f.list)||[],t=a.findIndex((function(e){return e.uid===n}));if(t>-1){var i=(0,s.Z)({},a[t]);i.role=r,a.splice(t,1,i),l({serverId:e,userListInfo:(0,s.Z)((0,s.Z)({},c.get(e)),{},{list:a})})}},_=function(e,n){var r=n.uid,s=n.serverId;if("kick"===e.key)$.Z.conn.removeServerMember({serverId:s,userId:r}).then((function(){m(r),pe.ZP.success("\u8e22\u51fa\u6210\u529f")}));else if("setAdmin"===e.key){var a={serverId:s,userId:r};$.Z.conn.setServerAdmin(a).then((function(){x(s,r,N.N1.moderator)}))}else if("removeAdmin"===e.key){var t={serverId:s,userId:r};$.Z.conn.removeServerAdmin(t).then((function(){x(s,r,"user")}))}},I=function(e){var n=e.cursor,r=void 0===n?"":n;$.Z.conn.getServerMembers({serverId:h,pageSize:20,cursor:r}).then((function(e){var n=e.data.list.map((function(e){return e.userId})),s=e.data.list.map((function(e){return{role:e.role,uid:e.userId}})),a=[];(0,Q.mZ)(n),a=""!==r?[].concat((0,T.Z)(f.list),(0,T.Z)(s)):s,l({serverId:h,userListInfo:{list:a,cursor:e.data.cursor,loadCount:e.data.list.length}})}))};return(0,i.useEffect)((function(){a&&I({cursor:""})}),[a]),(0,i.useEffect)((function(){t(!1)}),[h,v]),(0,ee.jsx)(he,{title:(0,ee.jsx)(Ce,{}),visible:a,onCancel:function(){t(!1)},children:(0,ee.jsx)("div",{id:je,className:oe.scrollWrap,children:(0,ee.jsx)(q.Z,{dataLength:(null===f||void 0===f||null===(n=f.list)||void 0===n?void 0:n.length)||0,next:function(){I({cursor:f.cursor})},hasMore:20===f.loadCount,loader:(0,ee.jsx)(ee.Fragment,{}),endMessage:(0,ee.jsx)(ee.Fragment,{}),scrollableTarget:je,children:null===f||void 0===f||null===(r=f.list)||void 0===r?void 0:r.map((function(e){return(0,ee.jsx)(ve.Z,{style:{padding:0},info:o[e.uid],uid:e.uid,operationReactNode:(0,ee.jsx)(ge,(0,s.Z)((0,s.Z)({isServer:!0,serverId:h},e),{},{onMenuClick:_,menuItems:be(p,e.role),isShowChat:e.uid!==$.Z.conn.user,showOpIcon:Ze(p,e.role,e).length>0,selfRole:p}))},e.uid)}))})})})}))),Me=r(7115),Ne=r(4760),Te=r(1982),ke=r(7083),Se={contactsItem:"index_contactsItem__lzFd6",mainInfo:"index_mainInfo__7X7N6",avatar:"index_avatar__kEaZt",basicInfo:"index_basicInfo__eGYGv",operation:"index_operation__HXDKF",scrollWrap:"index_scrollWrap__kxK+a",ellipsis:"index_ellipsis__oTGzT",name:"index_name__5taw-",muteIcon:"index_muteIcon__Iap+y"},we=r(1269),Le=(0,i.memo)((0,J.$j)(null,(function(e){return{setSelected:function(n){return e({type:"app/setSelectedTab",payload:n})}}}))((function(e){var n=(0,Y.s0)(),r=(0,Y.UO)(),a=r.serverId,t=r.channelId,o=e.info,l=e.uid,c=e.basicShowOnline,d=e.role,u=e.serverRole,h=e.channelMemberInfo,v=e.setChannelUserMap,p=e.muteList,f=void 0===p?[]:p,m=e.channelInfo,x=e.setSelected,_=u&&u[a],I=f.map((function(e){return e.userId})).includes(l),g=(0,i.useMemo)((function(){var e=[];return $.Z.conn.user!==l&&e.push(N.J2),(_===N.N1.owner&&d!==N.N1.owner||_===N.N1.moderator&&d===N.N1.user)&&(I?e.push(N.SY):e.push(N.Q2),1!==m.defaultChannel&&e.push(N.Ry)),e}),[l,_,d,I,m.defaultChannel]),j=[{label:(0,ee.jsx)(Z.Z,{iconClass:Se.icon,name:"ellipsis"}),key:"SubMenu",children:g}];return(0,ee.jsxs)("div",{className:Se.contactsItem,children:[(0,ee.jsx)("div",{className:Se.avatar,children:(0,ee.jsx)(G.Z,{name:(null===o||void 0===o?void 0:o.nickname)||l,src:null===o||void 0===o?void 0:o.avatarurl,online:null===o||void 0===o?void 0:o.online})}),(0,ee.jsxs)("div",{className:Se.mainInfo,children:[(0,ee.jsx)("div",{className:Se.basicInfo,children:(0,ee.jsx)(we.Z,{name:(0,ee.jsxs)("div",{className:Se.ellipsis,children:[(0,ee.jsx)("span",{className:Se.name,children:(null===o||void 0===o?void 0:o.nickname)||l}),I&&(0,ee.jsx)("span",{className:Se.muteIcon,children:(0,ee.jsx)(Z.Z,{style:{marginLeft:"4px"},size:"16px",name:"person_wave_slash"})})]}),icon:null===o||void 0===o?void 0:o.avatar,online:null===o||void 0===o?void 0:o.online,showOnline:c})}),(0,ee.jsx)("div",{className:Se.operation,children:(0,ee.jsx)(ge,{serverId:a,isShowChat:!1,showOpIcon:g.length>0,uid:l,role:d,onMenuClick:function(e,r){var i=r.uid;switch(e.key){case"chat":x("contacts"),n("/main/contacts/chat/".concat(i));break;case"mute":!function(e){$.Z.conn.muteChannelMember({serverId:a,channelId:t,userId:e,duration:-1}).then((function(){v({channelId:t,userListInfo:(0,s.Z)((0,s.Z)({},h),{},{muteList:f.length?[].concat((0,T.Z)(f),[{userId:e}]):[{userId:e}]})})})).catch((function(e){17===e.type&&"User is not in server."===JSON.parse(e.data).error_description&&pe.ZP.warn({content:"\u7528\u6237\u5df2\u9000\u51fa\u793e\u533a"})}))}(i);break;case"unmute":!function(e){$.Z.conn.unmuteChannelMember({serverId:a,channelId:t,userId:e}).then((function(){var n=[];if(null!==f&&void 0!==f&&f.length){var r=(n=f).findIndex((function(n){return n.userId===e}));n.splice(r,1)}v({channelId:t,userListInfo:(0,s.Z)((0,s.Z)({},h),{},{muteList:n})})})).catch((function(e){17===e.type&&"User is not in server."===JSON.parse(e.data).error_description&&pe.ZP.warn({content:"\u7528\u6237\u5df2\u9000\u51fa\u793e\u533a"})}))}(i);break;case"kick":!function(e){$.Z.conn.removeChannelMember({serverId:a,channelId:t,userId:e}).then((function(){var n=(0,T.Z)(h.list),r=n.findIndex((function(n){return e===n.uid}));r>-1&&(n.splice(r,1),v({channelId:t,userListInfo:(0,s.Z)((0,s.Z)({},h),{},{list:n})}))})).catch((function(e){17===e.type&&"User is not in server."===JSON.parse(e.data).error_description&&pe.ZP.warn({content:"\u7528\u6237\u5df2\u9000\u51fa\u793e\u533a"})}))}(i)}},menuItems:j})})]})]})}))),Ue="channelMemberScrollWrap",ze=(0,i.memo)((0,J.$j)((function(e){var n=e.app,r=e.channel;return{appUserInfo:n.appUserInfo,channelUserMap:r.channelUserMap,serverRole:n.serverRole,channelInfo:n.currentChannelInfo}}),(function(e){return{setChannelUserMap:function(n){return e({type:"channel/setChannelUserMap",payload:n})}}}))((function(e){var n,r,a=e.appUserInfo,t=e.channelUserMap,o=e.setChannelUserMap,l=e.serverRole,c=e.channelInfo,d=(0,Y.UO)(),u=d.serverId,h=d.channelId,v=(0,i.useMemo)((function(){return t.get(h)||{}}),[h,t]),p=l&&l[u],f=function(e){var n=e.cursor,r=void 0===n?"":n,a=e.muteList,t=void 0===a?null:a;$.Z.conn.getChannelMembers({serverId:u,channelId:h,pageSize:50,cursor:r}).then((function(e){var n=e.data.list.map((function(e){return e.userId})),a=e.data.list.map((function(e){return{role:e.role,uid:e.userId}})),i=[];(0,Q.mZ)(n),i=v.list&&""!==r?[].concat((0,T.Z)(v.list),(0,T.Z)(a)):a,o({channelId:h,userListInfo:(0,s.Z)((0,s.Z)({muteList:t},v),{},{list:i,cursor:e.data.cursor,loadCount:e.data.list.length})})}))};return(0,i.useEffect)((function(){"user"!==p?$.Z.conn.getChannelMutelist({serverId:u,channelId:h}).then((function(e){f({cursor:"",muteList:e.data.list})})):f({cursor:""})}),[u,h,p]),(0,ee.jsx)("div",{className:Se.scrollWrap,id:Ue,children:(0,ee.jsx)(q.Z,{scrollableTarget:Ue,dataLength:(null===v||void 0===v||null===(n=v.list)||void 0===n?void 0:n.length)||0,next:function(){f({cursor:null===v||void 0===v?void 0:v.cursor})},hasMore:50===v.loadCount,loader:(0,ee.jsx)(ee.Fragment,{}),endMessage:(0,ee.jsx)(ee.Fragment,{}),children:null===v||void 0===v||null===(r=v.list)||void 0===r?void 0:r.map((function(e){return(0,ee.jsx)(Le,{style:{padding:0},info:a[e.uid],uid:e.uid,role:e.role,serverRole:l,channelMemberInfo:v,setChannelUserMap:o,muteList:(null===v||void 0===v?void 0:v.muteList)||[],channelInfo:c},e.uid)}))})})}))),We=function(e){var n=e.onClose,r=void 0===n?function(){}:n,s=e.onInvite,a=e.channelInfo;return(0,ee.jsxs)("div",{className:m,children:[(0,ee.jsx)("span",{children:"\u9891\u9053\u6210\u5458"}),(0,ee.jsxs)("div",{className:x,children:[!(null!==a&&void 0!==a&&a.defaultChannel)&&(0,ee.jsx)("span",{className:_,children:(0,ee.jsx)(Z.Z,{iconClass:f,onClick:function(){s(N.ET.inviteChannel)},name:"person_plus",size:"24px"})}),(0,ee.jsx)("span",{className:I,children:(0,ee.jsx)(Z.Z,{iconClass:f,onClick:r,name:"xmark",size:"18px"})})]})]})},Oe=(0,i.memo)((0,J.$j)((function(e){var n=e.channel,r=e.app,s=e.thread,a=e.server;return{appUserInfo:r.appUserInfo,chatMap:r.chatMap,showThreadPanel:s.showThreadPanel,currentChannelInfo:r.currentChannelInfo,channelMemberVisible:n.channelMemberVisible,joinedServerInfo:a.joinedServerInfo,currentThreadInfo:s.currentThreadInfo}}),(function(e){return{setVisible:function(n){return e({type:"channel/setVisible",payload:n})},pushChatMessage:function(n){return e({type:"app/pushChatMessage",payload:n})},handleThreadPanel:function(n){return e({type:"thread/setThreadPanelStatus",payload:n})},setIsCreatingThread:function(n){return e({type:"thread/setIsCreatingThread",payload:n})},setThreadInfo:function(n){return e({type:"thread/setThreadInfo",payload:n})},setMsgReaction:function(n){return e({type:"app/setMsgReaction",payload:n})},setThreadHasHistory:function(n){return e({type:"thread/setThreadHasHistory",payload:n})},setChannelMemberVisible:function(n){return e({type:"channel/setChannelMemberVisible",payload:n})},setChannelFormVisible:function(n){return e({type:"channel/setChannelVisible",payload:n})},setInviteVisible:function(n){return e({type:"channel/setInviteVisible",payload:n})},insertChatMessage:function(n){return e({type:"app/insertChatMessage",payload:n})},setThreadMap:function(n){return e({type:"channel/setThreadMap",payload:n})}}}))((function(e){var n,r,f=e.setVisible,m=e.chatMap,x=e.showThreadPanel,_=e.pushChatMessage,I=e.handleThreadPanel,g=e.setIsCreatingThread,j=e.channelMemberVisible,C=e.setChannelMemberVisible,Z=e.currentChannelInfo,b=e.setThreadInfo,y=e.setMsgReaction,M=e.setThreadHasHistory,T=e.setChannelFormVisible,k=e.setInviteVisible,S=e.insertChatMessage,w=e.joinedServerInfo,L=e.currentThreadInfo,U=e.setThreadMap,z=(0,Y.UO)(),W=z.serverId,O=z.channelId,V=(0,i.useRef)(),R=(0,i.useMemo)((function(){return m[N.zi.groupChat].get(O)||{}}),[O,m]),P=(0,i.useCallback)(function(){var e=(0,t.Z)((0,a.Z)().mark((function e(n){var r,s,t,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.channelId,s=n.cursor,t=void 0===s?"":s,e.prev=1,e.next=4,$.Z.conn.getChatThreads({parentId:r,pageSize:N.LI,cursor:t});case 4:i=e.sent,U({channelId:r,threadInfo:{list:i.entities,cursor:i.properties.cursor,loadCount:i.entities.length}}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),console.log(e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(n){return e.apply(this,arguments)}}(),[U]),E=(0,i.useCallback)((function(){W&&O&&$.Z.conn.isInChannel({serverId:W,channelId:O}).then((function(e){e.data.result||$.Z.conn.joinChannel({serverId:W,channelId:O}).then((function(e){P({channelId:O});var n=(0,Q.bD)({chatType:N.zi.groupChat,type:"custom",to:O,customEvent:N.qm.acceptInviteChannel,customExts:{server_name:A.name,channel_name:e.data.name}});(0,Q.j5)(n).then((function(){S({chatType:n.chatType,fromId:n.to,messageInfo:{list:[(0,s.Z)((0,s.Z)({},n),{},{from:$.Z.conn.user})]}})}))}))}))}),[W,O]),H=function(e){var n=e.cursor,r=void 0===n?"":n;$.Z.conn.getHistoryMessages({targetId:O,pageSize:20,chatType:"groupChat",cursor:r}).then((function(e){e.messages.forEach((function(e){y({msgId:e.id,reactions:e.reactions})})),_({chatType:"groupChat",fromId:O,messageInfo:{list:e.messages,cursor:e.cursor,loadCount:e.messages.length},reset:!r})}))};(0,i.useEffect)((function(){I(!1),b({}),H({cursor:""})}),[O]);var X=function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;switch(e){case"createThread":C(!1),g(!0),b({parentMessage:r}),I(!0),M(!1);break;case"openThreadPanel":var a="threadList"===s?r.id:r.chatThreadOverview.id;if(a===L.id)return;$.Z.conn.joinChatThread({chatThreadId:a}).then((function(e){C(!1),F(r,s)})).catch((function(e){1301===e.type?(C(!1),F(r,s)):1300===e.type&&pe.ZP.warn({content:"\u8be5\u5b50\u533a\u5df2\u7ecf\u88ab\u9500\u6bc1"})}));break;case"showMember":b({}),I(!1),C(!j);break;case"setting":T("edit");break;case"recall":(0,Q.pe)(r,n)}},F=function(e,n){g(!1);var r="threadList"===n?e.id:e.chatThreadOverview.id;$.Z.conn.getChatThreadDetail({chatThreadId:r}).then((function(r){var a="threadList"===n?(0,Q.rS)(e.parentId,e.messageId):e,t=a?(0,s.Z)((0,s.Z)({},a),{},{chatThreadOverview:{}}):{};b((0,s.Z)((0,s.Z)({},r.data),{},{parentMessage:t})),I(!0)}))};(0,i.useEffect)((function(){return function(){f(!1)}}),[W]),(0,i.useEffect)((function(){E()}),[W,O]);var A=(0,i.useMemo)((function(){return function(e){var n=e.serverId,r=void 0===n?"":n,s=e.serverList,a=(void 0===s?[]:s).filter((function(e){return e.id===r}));return a.length?a[0]:{}}({serverId:W,serverList:w.list})}),[W,w]);return(0,ee.jsxs)("div",{ref:V,className:o,children:[(0,ee.jsxs)("div",{className:u,children:[(0,ee.jsx)(ie,{serverId:W,channelId:O,onHandleOperation:X}),(0,ee.jsxs)("div",{className:l,children:[(0,ee.jsx)("div",{id:N.jZ,className:c,children:(0,ee.jsx)(q.Z,{inverse:!0,dataLength:(null===R||void 0===R||null===(n=R.list)||void 0===n?void 0:n.length)||0,next:function(){H({cursor:null===R||void 0===R?void 0:R.cursor})},hasMore:(null===R||void 0===R?void 0:R.loadCount)>=20,style:{display:"flex",flexDirection:"column-reverse",minHeight:"435px"},loader:(0,ee.jsx)(ke.Z,{}),endMessage:(0,ee.jsx)("div",{style:{textAlign:"center"},children:"\u6ca1\u6709\u66f4\u591a\u6d88\u606f\u5566\uff5e"}),scrollableTarget:N.jZ,children:null===R||void 0===R||null===(r=R.list)||void 0===r?void 0:r.map((function(e){return(0,ee.jsx)("div",{children:(0,ee.jsx)(Me.Z,{parentId:O,message:e,onHandleOperation:X,source:N.Z5.groupChat})},e.id)}))})}),(0,ee.jsx)("div",{className:d,children:(0,ee.jsx)(Ne.Z,{chatType:N.zi.groupChat,fromId:O})})]})]}),(0,ee.jsx)(ye,{}),x&&(0,ee.jsx)("div",{className:h,children:(0,ee.jsx)(Te.default,{})}),j&&(0,ee.jsxs)("div",{className:v,children:[(0,ee.jsx)(We,{channelInfo:Z,onInvite:k,onClose:function(){C(!1)}}),(0,ee.jsx)("div",{className:p,children:(0,ee.jsx)(ze,{})})]})]})})))}}]);
//# sourceMappingURL=127.48b3f71d.chunk.js.map